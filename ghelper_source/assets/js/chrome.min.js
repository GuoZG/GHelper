manifest=get_manifest();var sync_session_id=false;var trytime=10;var tabs_data={};var api_urls=[];api_urls.push('https://www.chromehelper.net');api_urls.push('https://www.speedstunnel.com');api_urls.push('https://www.ghelper.org');api_urls.push('https://ipv6.chromehelper.net');api_urls.push('https://cdn.speedstunnel.com');api_urls.push('https://global.speedstunnel.com');function getlang(name){return chrome.i18n.getMessage(name);}
function notify(title,options={}){return new Notification(title,options);}
function notify2(title,body=null,url=null){var options={};if(body){options['body']=body;}
msg=new Notification(title,options);if(url){msg.onclick=function(){window.open(url)}}
return msg;}
function set_proxy(proxy_pac_key,conf){chrome.proxy.settings.set(conf,function(){set_proxy_pac_key(proxy_pac_key);});}
function get_local_data(){var data={};data['gtoken']=get_token();data['version']=manifest.version;data['proxy_pac_key']=get_proxy_pac_key();data['api_url']=get_api_url();data['lang']=get_client_lang();data['client_id']=get_client_id();data['time']=get_time();return data;}
function alert_dump(data){alert(JSON.stringify(data));}
function get_request_uri(default_url){var uri=window.location.href;var off=uri.indexOf('?');if(off<0){return default_url;}
return uri.slice(off+1);}
function getQueryVars(uri){if(uri.indexOf('?')<0){return{}}
var vars={};var query=uri.slice(uri.indexOf('?')+1).split('&');for(val in query){q=query[val].split('=');vars[q[0]]=q[1];}
return vars;}
function purl(path,up=false){if(up){var api_url=api_urls.shift();set_api_url(api_url);api_urls.push(api_url);}
var api_url=get_api_url();if(!api_url){return purl(path,true);}
var query=get_local_data();var pquery=getQueryVars(path);for(k in pquery){query[k]=pquery[k];}
path=path.split('?')[0];return api_url+path+'?'+$.param(query);}
function get_time(){var date=new Date();return(date.getTime()/1000);}
function get_client_id(){return chrome.runtime.id;}
function get_token(){return localStorage.getItem('token');}
function set_token(token){return localStorage.setItem('token',token);}
function set_proxy_pac_key(proxy_pac_key){localStorage.setItem('proxy_pac_key',proxy_pac_key);}
function get_proxy_pac_key(){return localStorage.getItem('proxy_pac_key');}
function set_api_url(api_url){localStorage.setItem('api_url',api_url);}
function get_api_url(){return localStorage.getItem('api_url');}
function get_client_lang(){return window.navigator.language;}
function get_manifest(){return chrome.runtime.getManifest();}
function handle(data){if(data.headers){if(data.headers.sync_time){set_sync_time(data.headers.sync_time);}
if(data.headers.set_token){set_token(data.headers.set_token);}
if(data.headers.test_server){test_server(data.headers.test_server);}
if(data.headers.set_proxy&&data.headers.proxy_pac_key){set_proxy(data.headers.proxy_pac_key,data.headers.set_proxy);}
if(data.headers.notify){notify(data.headers.notify.title,data.headers.notify.options);}
if(data.headers.open_tab){window.open(data.headers.open_tab.url,'ghelper');}
if(data.headers.location){window.location=data.headers.location;}}
if(data.html){for(tag in data.html){$(tag).html(data.html[tag]);}
handle_html();}}
function handle_html(){$('form').submit(function(){var url=$(this).attr('action');var data=$(this).serialize();request(url,'POST',data,false);return false;});$('.ajax').click(function(){var url=$(this).attr('href');request(url,'GET',null,false);return false;});check_proxy_config(1);}
function session(action='reload',async=true,up=false,tn=1){var data=false;if(tn>=trytime){return data;}
var pdata=get_local_data();var url=purl('/server/session',up);pdata['action']=action;var conf={};conf['url']=url;conf['type']='POST';conf['async']=async;conf['cache']=false;conf['timeout']=10000;conf['data']=pdata;conf['success']=function(res){handle(res);data=res;localStorage.setItem('session_sync',get_time());}
conf['error']=function(err){data=session(action,async,true,tn+1);}
$.ajax(conf);return data;}
function clearSync(){if(sync_session_id){clearInterval(sync_session_id);}}
function set_sync_time(sync_time=3600000){clearSync();sync_session_id=setInterval(function(){if(get_proxy_pac_key()){session('reload');}else{if(session('start',false)){}}},sync_time);}
function request(url,method="GET",data=null,async=true,up=false,tn=1,callfunc=null){var conf={};conf['url']=purl(url,up);if(data){conf['data']=data;}
conf['type']=method;conf['cache']=false;conf['timeout']=10000;conf['async']=async;conf['success']=function(res){handle(res);callfunc&&callfunc();}
conf['error']=function(err){if(tn>=trytime){error_html(err);}else{return request(url,method,data,async,true,tn+1,callfunc);}}
$.ajax(conf);}
function start(){set_proxy_pac_key('');set_api_url('');session('start');}
function error_html(err){var html='<div class="container">';html+='<div class="alert alert-danger error"  role="alert">';html+='<h1><i class="glyphicon glyphicon-warning-sign"></i></h1>';html+='<h3>'+getlang('error_code')+' : '+err.status+'</h3>';html+='<h4>'+getlang('error_network')+'</h4>';html+='<h5><a href="error.html" target="_blank" class="btn btn-warning">'+getlang('error_button')+'</a></h5>';html+='</div></div>';$('body').html(html);}
function test_speed(conf){var start=get_time();var url=conf.test_url;var post_url=conf.post_url;;$.get(url,function(){var end=get_time();conf['start']=start;conf['end']=end;conf['speed']=end-start;$.post(post_url,conf,function(res){handle(res);});});}
function test_server(servers){for(val in servers){test_speed(servers[val]);}}
function check_proxy_config(show=0){chrome.proxy.settings.get({'incognito':false},function(config){if(config['levelOfControl']!='controlled_by_this_extension'){if(show){$('#alert-messager').html('<span class="label label-danger"><i class="glyphicon glyphicon-exclamation-sign"></i>'+getlang('check_proxy_config_title')+'</span>'+getlang('check_proxy_config_body'));}else{$('#alert-messager').html('<span class="label label-danger"><i class="glyphicon glyphicon-exclamation-sign"></i>'+getlang('check_proxy_config_title')+'</span>');}}
});}
function cancel_urls(details){return{cancel:true};}
function set_block_urls(block_urls){chrome.webRequest.onBeforeRequest.addListener(cancel_urls,{urls:block_urls},["blocking"]);localStorage.setItem('adblock','on');}
function remove_block_urls(){chrome.webRequest.onBeforeRequest.removeListener(cancel_urls);}
function message_handler(request,sender,sendResponse){if(request=='remove_block_urls'){remove_block_urls();}}
function tabs_updated_handler(id,status,tab){if(!tabs_data.hasOwnProperty(id)){tabs_data[id]=[]}}
function tabs_removed_handler(id,info){if(tabs_data.hasOwnProperty(id)){delete tabs_data[id];}}
function brower_urls_handler(details){var id=details.tabId;if(tabs_data.hasOwnProperty(id)){tabs_data[id].push(details);}
}